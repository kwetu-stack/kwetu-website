{% extends "base.html" %}
{% block title %}New Order | SalesPro360{% endblock %}
{% block content %}

<div class="form-container">
  <h2>Book Order</h2>

  <form method="post" id="orderForm" autocomplete="off">
    <!-- Meta -->
    <div class="form-row">
      <div class="form-group">
        <label>Order No</label>
        <input type="text" value="{{ order_no }}" readonly>
        <small>Generated on save</small>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="todayDate" readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Sales Rep</label>
        <!-- Free text for display; server still maps/guards rep_id -->
        <input type="text" name="sales_rep" value="" placeholder="Rep name">
      </div>

      <div class="form-group">
        <label for="supplier">Supplier (filter)</label>
        <select name="supplier_filter" id="supplier">
          <option value="">All suppliers</option>
          {% for s in suppliers %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
        <small>Use this to filter the product list. Items already added are kept.</small>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Customer Name</label>
        <input type="text" name="customer_name" placeholder="e.g. Garisa Mtwapa">
      </div>
      <div class="form-group">
        <label>Customer Location</label>
        <input type="text" name="customer_location" placeholder="e.g. Mtwapa, Kilifi">
      </div>
    </div>

    <!-- Product picker -->
    <div class="card" style="padding:12px; margin-bottom:14px;">
      <div class="form-row" style="align-items:flex-start;">
        <div class="form-group" style="flex:1; min-width:280px;">
          <label>Products (filtered by supplier)</label>
          <input id="productSearch" type="text" placeholder="Search product..." style="margin-bottom:8px;">
          <select id="productPicker" size="8" style="width:100%; min-height:220px;"></select>
          <small id="pickerHelp">Select a product then tap <b>Add Item</b>.</small>
          <small id="pickerMsg" style="color:#f88;display:none;margin-top:6px;">Pick a product first.</small>
        </div>
        <div class="form-group" style="flex:1; min-width:220px;">
          <label style="opacity:.8;">Action</label>
          <button type="button" id="addItemBtn" class="btn" style="width:100%;padding:10px 12px;">+ Add Item</button>
          <small style="display:block;margin-top:6px;">Adding the same product again increases its quantity.</small>
        </div>
      </div>
    </div>

    <!-- Lines -->
    <div class="card" style="padding:12px;">
      <div class="form-row" style="margin-bottom:8px;">
        <strong style="flex:3;">Product</strong>
        <strong style="flex:1; text-align:center;">Qty</strong>
        <strong style="flex:1;">Price / Ctn</strong>
        <strong style="flex:1;">Amount</strong>
        <span style="width:40px;"></span>
      </div>

      <div id="lines"></div>

      <div style="display:flex; justify-content:flex-end; margin-top:12px;">
        <div style="min-width:220px; text-align:right;">
          <div style="font-size:0.9rem; opacity:.8;">Total</div>
          <div id="totalDisplay" style="font-size:1.2rem; font-weight:600;">0.00</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="form-row">
      <div class="form-group" style="flex:1;">
        <label>Total Amount (KES) *</label>
        <input type="number" name="amount" id="totalAmount" placeholder="Auto from items" min="0" step="0.01" required>
        <small>Auto-calculated (you may override).</small>
      </div>
      <div class="form-group" style="flex:1;">
        <label>Comments / Terms</label>
        <textarea name="notes" rows="3" placeholder="Delivery terms, payment mode, etc."></textarea>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Payment Method</label>
        <input type="text" name="payment_method" placeholder="e.g. M-PESA, Bank Transfer">
      </div>
      <div class="form-group">
        <label>Delivery Date</label>
        <input type="date" name="delivery_date">
      </div>
      <div class="form-group">
        <label>Currency</label>
        <input type="text" name="currency" value="KES" readonly>
      </div>
    </div>

    <div class="form-row" style="gap:10px;">
      <button type="submit">Save Order</button>
      <a href="{{ url_for('orders_history') }}" class="btn">← Orders History</a>
    </div>
  </form>
</div>

<!-- Hidden line template -->
<template id="lineTemplate">
  <div class="line" style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
    <div style="flex:3;">
      <div class="prod-label" style="line-height:1.2;"></div>
      <div class="tags" style="font-size:.8rem; opacity:.8; margin-top:2px;"></div>
      <input type="hidden" name="product_id[]" class="prod-id">
      <input type="hidden" name="supplier_id[]" class="supp-id">
      <input type="hidden" name="desc[]" class="prod-name">
    </div>

    <div class="qty-wrap" style="flex:1; display:flex; align-items:center; justify-content:center; gap:6px;">
      <button type="button" class="qty-step down">−</button>
      <input type="number" class="qty-input" name="qty[]" min="1" step="1" value="1" inputmode="numeric" pattern="[0-9]*" style="width:70px; text-align:center;">
      <button type="button" class="qty-step up">+</button>
    </div>

    <input type="number" class="price-input" name="unit_price[]" placeholder="0.00" min="0" step="0.01" style="flex:1;">
    <input type="text" class="amount-input" name="line_amount[]" placeholder="0.00" style="flex:1;" readonly>
    <button type="button" class="btn-danger remove-line" title="Remove" style="width:40px;">×</button>
  </div>
</template>

<style>
  .form-row { display:flex; gap:14px; flex-wrap:wrap; }
  .form-group { display:flex; flex-direction:column; min-width:220px; flex:1; }
  .btn-danger { background:#b33; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
  select, input, textarea, .qty-step {
    padding:10px; border:1px solid #444; border-radius:8px; background:#0e1525; color:#e8eef7;
  }
  #productPicker { width:100%; }
  .qty-step { min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #556; margin-right:6px; }
  .shake { animation: shake .25s linear 1; }
  @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(4px)}50%{transform:translateX(-4px)}75%{transform:translateX(3px)}100%{transform:translateX(0)} }
</style>

<script>
(() => {
  if (window.__ordersNewInit__) return;
  window.__ordersNewInit__ = true;

  const todayDate = document.getElementById('todayDate');
  const tz = new Date();
  const iso = new Date(tz.getTime() - tz.getTimezoneOffset()*60000).toISOString().slice(0,10);
  if (todayDate) todayDate.value = iso;

  const supplierEl     = document.getElementById('supplier');
  const supplierNameById = {};
  {% for s in suppliers %}
    supplierNameById["{{ s.id }}"] = "{{ s.name|e }}";
  {% endfor %}

  const productSearch  = document.getElementById('productSearch');
  const productPicker  = document.getElementById('productPicker');
  const addItemBtn     = document.getElementById('addItemBtn');
  const linesEl        = document.getElementById('lines');
  const tpl            = document.getElementById('lineTemplate');
  const totalDisplay   = document.getElementById('totalDisplay');
  const totalAmount    = document.getElementById('totalAmount');
  const pickerMsg      = document.getElementById('pickerMsg');

  const productCache   = new Map();
  let currentRaw = [];

  function money(n){ return (parseFloat(n||0) || 0).toFixed(2); }

  function normalize(list, fallbackSupplierId) {
    return (Array.isArray(list) ? list : []).map(p => {
      const id   = p.id ?? p.product_id ?? p.value ?? "";
      const name = p.name ?? p.label ?? p.title ?? String(id);
      const price= Number.isFinite(+p.default_price) ? +p.default_price : 0;
      const sid  = p.supplier_id ?? fallbackSupplierId ?? "";
      return id ? { id, name, default_price: price, supplier_id: String(sid) } : null;
    }).filter(Boolean);
  }

  function renderPicker(products){
    productPicker.innerHTML = '';
    if (!products.length){
      const o = document.createElement('option');
      o.value = ''; o.textContent = 'No products found';
      productPicker.appendChild(o); productPicker.selectedIndex = -1;
      return;
    }
    products.forEach(p => {
      const o = document.createElement('option');
      o.value = p.id;
      o.textContent = p.name;
      o.dataset.price = p.default_price;
      o.dataset.supplier = p.supplier_id;
      productPicker.appendChild(o);
    });
    productPicker.selectedIndex = -1;
  }

  async function loadProductsForFilter(sid){
    productPicker.innerHTML = '<option>Loading products…</option>';
    productSearch.value = '';
    if (productCache.has(sid)){
      currentRaw = productCache.get(sid);
      renderPicker(currentRaw);
      return;
    }
    try {
      const resp = await fetch(`/api/products?supplier_id=${encodeURIComponent(sid)}`, { credentials:'same-origin' });
      const data = await resp.json();

      // ---- strict client-side filter by supplier (tiny fix) ----
      const normalized = normalize(data.products, sid || "");
      const sidStr = sid ? String(sid) : "";
      const filtered = sidStr ? normalized.filter(p => String(p.supplier_id) === sidStr) : normalized;
      currentRaw = filtered;
      productCache.set(sid, filtered);
      // ----------------------------------------------------------
    } catch {
      currentRaw = [];
    }
    renderPicker(currentRaw);
  }

  function filterPicker() {
    const q = productSearch.value.trim().toLowerCase();
    if (!q) { renderPicker(currentRaw); return; }
    const filtered = currentRaw.filter(p => p.name.toLowerCase().includes(q));
    renderPicker(filtered);
  }

  function recalcRow(line){
    const q = parseFloat(line.querySelector('.qty-input').value || '0');
    const p = parseFloat(line.querySelector('.price-input').value || '0');
    line.querySelector('.amount-input').value = money(q > 0 ? q * p : 0);
  }

  function recalcTotal(){
    let sum = 0;
    linesEl.querySelectorAll('.line').forEach(line => {
      recalcRow(line);
      sum += parseFloat(line.querySelector('.amount-input').value || '0');
    });
    totalDisplay.textContent = money(sum);
    if (document.activeElement !== totalAmount && totalAmount) totalAmount.value = money(sum);
  }

  function keyFor(sid, pid){ return `${sid}|${pid}`; }

  function findRowByKey(key){
    return [...linesEl.querySelectorAll('.line')].find(l => l.dataset.key === key) || null;
  }

  function addOrMerge(item){
    const k = keyFor(item.supplier_id, item.id);
    const existing = findRowByKey(k);
    if (existing){
      const qty = existing.querySelector('.qty-input');
      qty.value = String((parseInt(qty.value || '1', 10) || 1) + 1);
      recalcTotal(); qty.focus(); return;
    }

    const frag = tpl.content.cloneNode(true);
    const row  = frag.querySelector('.line');
    row.dataset.key = k;

    row.querySelector('.prod-label').textContent = item.name;
    const tags = row.querySelector('.tags');
    const suppName = supplierNameById[item.supplier_id] || 'Supplier';
    tags.innerHTML = `<span class="badge">${suppName}</span>`;

    row.querySelector('.prod-id').value  = item.id;
    row.querySelector('.supp-id').value  = item.supplier_id;
    row.querySelector('.prod-name').value= item.name;

    const priceEl = row.querySelector('.price-input');
    priceEl.value = money(item.default_price || 0);

    linesEl.appendChild(frag);
    recalcTotal();
  }

  supplierEl.addEventListener('change', () => {
    const sid = supplierEl.value || '';
    loadProductsForFilter(sid);
  });

  productSearch.addEventListener('input', filterPicker);

  addItemBtn.addEventListener('click', () => {
    const opt = productPicker.options[productPicker.selectedIndex];
    if (!opt || !opt.value){
      pickerMsg.style.display = 'block';
      productPicker.classList.add('shake'); setTimeout(()=>productPicker.classList.remove('shake'), 250);
      return;
    }
    pickerMsg.style.display = 'none';
    const item = {
      id: opt.value,
      name: opt.textContent.trim(),
      default_price: parseFloat(opt.dataset.price || '0') || 0,
      supplier_id: String(opt.dataset.supplier || supplierEl.value || '')
    };
    addOrMerge(item);
    productPicker.selectedIndex = -1;
  });

  linesEl.addEventListener('click', (e) => {
    const t = e.target;
    if (t.classList.contains('remove-line')){
      t.closest('.line').remove();
      recalcTotal();
    } else if (t.classList.contains('qty-step')){
      const line = t.closest('.line');
      const qty  = line.querySelector('.qty-input');
      let v = parseInt(qty.value || '1', 10) || 1;
      if (t.classList.contains('up')) v += 1; else v = Math.max(1, v - 1);
      qty.value = String(v);
      recalcTotal();
    }
  });

  linesEl.addEventListener('input', (e) => {
    const t = e.target;
    if (t.classList.contains('qty-input') || t.classList.contains('price-input')){
      recalcTotal();
    }
  });

  if (totalAmount){
    totalAmount.addEventListener('input', () => totalDisplay.textContent = money(totalAmount.value));
  }

  document.getElementById('orderForm').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') e.preventDefault();
  });

  document.getElementById('orderForm').addEventListener('submit', (e) => {
    if (!linesEl.querySelector('.line')){
      e.preventDefault();
      alert('Add at least one item to save the order.');
      return false;
    }
    linesEl.querySelectorAll('.line').forEach(line => {
      const pid = line.querySelector('.prod-id').value;
      if (!pid) line.remove();
    });
    recalcTotal();
  });

  // boot
  loadProductsForFilter(supplierEl.value || '');
})();
</script>

{% endblock %}
